<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="../assets/favicon.ico" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link rel="stylesheet" href="/styles/main.css" />
    <link rel="stylesheet" href="/styles/settings.css" />
    <title>MindHive Â· Settings</title>
  </head>

  <body>
    <%- include('partials/sidebar', { page: 'settings' }) %>

    <div class="settings-container">
      <h1>Settings</h1>

      <% const hasUser = typeof user !== 'undefined' && user; const firstName =
      hasUser && user.first_name ? user.first_name : 'Student'; const lastName =
      hasUser && user.last_name ? (' ' + user.last_name) : ''; const handle =
      hasUser && user.username ? user.username : hasUser && user.email ?
      user.email.split('@')[0] : 'username'; %>

      <!-- PROFILE CARD -->
      <section class="profile-card">
        <div class="profile-left">
          <% if (user && user.profile_image) { %>
          <img
            src="<%= user.profile_image %>"
            class="profile-avatar-img"
            alt="Profile Picture"
          />
          <% } else { %>
          <div class="profile-avatar">
            <span
              ><%= firstName.charAt(0).toUpperCase() %><%= lastName.trim() ?
              lastName.trim().charAt(0).toUpperCase() : '' %></span
            >
          </div>
          <% } %>

          <div class="profile-main">
            <h2 class="profile-name"><%= firstName + lastName %></h2>
            <p class="profile-handle">@<%= handle %></p>
          </div>
        </div>

        <div class="profile-right">
          <div class="profile-stat">
            <span class="stat-label">Rank</span>
            <span class="stat-value" id="profile-rank">
              <%= rankTitle %> <%= rankEmoji %>
            </span>
          </div>

          <div class="profile-stat">
            <span class="stat-label">Position</span>
            <span class="stat-value" id="profile-position"
              >#<%= position %></span
            >
          </div>

          <div class="profile-stat">
            <span class="stat-label">Student Score</span>
            <div class="stat-value"><%= totalPoints %> pts</div>
          </div>

          <button type="button" class="edit-profile-btn" id="edit-profile-btn">
            <i class="fa-solid fa-pen"></i> Edit Profile
          </button>
        </div>
      </section>

      <!-- SETTINGS LIST -->
      <form id="settings-form" class="settings-form">
        <ul>
          <li>
            <button type="button" class="settings-button" id="change-password">
              <h3>Change Password</h3>
            </button>
          </li>
          <li>
            <button type="button" class="settings-button" id="log-out">
              <h3>Log Out</h3>
            </button>
          </li>
          <li>
            <button type="button" class="settings-button" id="red-btn">
              <h3>Delete Account</h3>
            </button>
          </li>
        </ul>
      </form>

      <footer class="settings-footer">
        <p>
          &copy; 2025 MindHive. All rights reserved.
          <a href="https://mindhive-328e.onrender.com/api-docs/"
            ><i>View Documentation</i></a
          >
        </p>
      </footer>

      <!-- PASSWORD MODAL -->
      <div id="password-modal" class="password-modal hidden">
        <div class="modal-content">
          <h2>Change Password</h2>

          <div class="modal-input-group">
            <input
              type="password"
              id="current_password"
              placeholder="Current Password"
              class="modal-input"
            />
            <input
              type="password"
              id="new_password"
              placeholder="New Password"
              class="modal-input"
            />
          </div>

          <div class="modal-button-row">
            <button id="submit-password" class="confirm-btn">
              Update Password
            </button>
            <button id="cancel-modal" class="cancel-btn">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- EDIT PROFILE MODAL -->
    <div id="edit-profile-modal" class="edit-profile-modal hidden">
      <div class="edit-profile-content">
        <h2>Edit Profile</h2>

        <!-- Avatar -->
        <div class="edit-avatar-wrapper">
          <% if (user && user.profile_image) { %>
          <img
            id="edit-avatar-preview"
            src="<%= user.profile_image %>"
            class="edit-avatar-img"
          />
          <% } else { %>
          <div id="edit-avatar-preview" class="edit-avatar-placeholder">
            <%= firstName.charAt(0).toUpperCase() %><%= lastName.trim() ?
            lastName.trim().charAt(0).toUpperCase() : '' %>
          </div>
          <% } %>

          <!-- PHOTO ACTIONS ROW -->
          <div class="photo-action-row">
            <p id="photo-error" class="photo-error hidden"></p>
            <label for="profileImageInput" class="upload-btn">
              <i class="fa-solid fa-camera"></i> Change Photo
            </label>

            <% if (user && user.profile_image) { %>
            <button id="remove-profile-image" class="remove-img-btn">
              Remove Photo
            </button>
            <% } %>
          </div>

          <input
            type="file"
            id="profileImageInput"
            name="profile_image"
            accept="image/*"
            hidden
          />
        </div>

        <!-- INPUTS -->
        <div class="edit-fields">
          <input
            type="text"
            id="edit-firstname"
            class="edit-input"
            placeholder="First Name"
            value="<%= firstName %>"
          />
          <input
            type="text"
            id="edit-lastname"
            class="edit-input"
            placeholder="Last Name"
            value="<%= lastName.trim() %>"
          />
          <input
            type="text"
            id="edit-username"
            class="edit-input"
            placeholder="Username"
            value="<%= handle %>"
          />
        </div>

        <!-- BUTTON ROW -->
        <div class="edit-button-row">
          <button id="save-profile-info" class="confirm-btn">
            Save Changes
          </button>
          <button id="cancel-edit-profile" class="cancel-btn">Cancel</button>
        </div>
      </div>
    </div>

    <script src="/js/settings.js"></script>
  </body>
</html>
